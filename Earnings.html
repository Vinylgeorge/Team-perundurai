<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ’° Daily MTurk Earnings Monitor</title>

<script type="module">
/* ============================
   FIREBASE IMPORTS
============================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  initializeFirestore,
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ============================
   FIREBASE CONFIG
============================ */
const earningsConfig = {
  apiKey: "AIzaSyBTFpM3fs7kWBrZL4yOi9tquUTp1HhH7L8",
  authDomain: "mturk-monitordeep.firebaseapp.com",
  projectId: "mturk-monitordeep",
  storageBucket: "mturk-monitordeep.firebasestorage.app",
  messagingSenderId: "505786000194",
  appId: "1:505786000194:web:40b9c9df75d3125f3a99cd"
};

const app = initializeApp(earningsConfig);
const db = initializeFirestore(app, {
  experimentalForceLongPolling: true,
  useFetchStreams: false
});

/* ============================
   STORAGE KEYS
============================ */
const CACHE_KEY = "earnings_cache_data";
const SYNC_KEY  = "earnings_last_sync";
const TRANSFER_KEY = "earnings_transfers_cache";

/* ============================
   HELPERS
============================ */
function today(){ return new Date().toISOString().slice(0,10); }
function needsSync(){ return localStorage.getItem(SYNC_KEY) !== today(); }
function markSynced(){ localStorage.setItem(SYNC_KEY, today()); }

function parseDate(v){
  if(!v) return null;
  const d = new Date(v);
  return isNaN(d) ? null : d;
}

function isAfterFifth(d){
  const dt = parseDate(d);
  return dt && dt.getDate() > 5;
}

/* TEMP RULE: visible until 8th of next month */
function isActiveTill8th(d){
  const dt = parseDate(d);
  if(!dt) return false;
  const cutoff = new Date(dt.getFullYear(), dt.getMonth()+1, 8);
  return new Date() < cutoff;
}

/* ============================
   LOAD TEAM CSV
============================ */
async function loadTeam(){
  const res = await fetch(
    "https://docs.google.com/spreadsheets/d/1mf2-AQ59CuboAWz8Fle3qXTFfAI3cnB7mrkqQF1lyCw/export?format=csv&gid=0"
  );
  const text = await res.text();
  const lines = text.split("\n").filter(Boolean);

  const users = new Set();
  const workers = new Set();

  for(let i=1;i<lines.length;i++){
    const [u,w] = lines[i].split(",");
    if(u) users.add(u.trim());
    if(w) workers.add(w.trim());
  }
  return {users, workers};
}

/* ============================
   FIRESTORE FETCH (DAILY)
============================ */
async function fetchDocs(){
  const snap = await getDocs(collection(db, "earnings_logs"));
  const arr = [];
  snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  localStorage.setItem(CACHE_KEY, JSON.stringify(arr));
  markSynced();
  return arr;
}

function loadCache(){
  return JSON.parse(localStorage.getItem(CACHE_KEY)||"[]");
}

/* ============================
   TRANSFER CACHE (APPEND)
============================ */
function loadTransferCache(){
  return JSON.parse(localStorage.getItem(TRANSFER_KEY)||"[]");
}
function saveTransferCache(v){
  localStorage.setItem(TRANSFER_KEY, JSON.stringify(v));
}

function refreshTransfers(docs, users, workers){
  let cache = loadTransferCache().filter(t=>isActiveTill8th(t.date));

  for(const d of docs){
    const user = (d.user||"").trim();
    const wid  = (d.workerId||d.id||"").trim();

    if(!users.has(user) && !workers.has(wid)) continue;

    const amt = Number(d.lastTransferAmount||0);
    const dt  = d.lastTransferDate;

    if(amt<8) continue;
    if(!isAfterFifth(dt)) continue;
    if(!isActiveTill8th(dt)) continue;

    const exists = cache.some(t=>
      t.user===user &&
      t.wid===wid &&
      t.amount===amt &&
      t.date===dt
    );

    if(!exists){
      const lm = Number(d.lastMonthEarnings||0);
      const mismatch =
        lm>0 && Math.abs(lm-amt)>0.01 &&
        parseDate(dt)?.getDate()>=6;

      cache.push({
        user, wid,
        amount:amt,
        date:dt,
        mismatch
      });
    }
  }
  saveTransferCache(cache);
  return cache;
}

/* ============================
   BUILD DATA
============================ */
let QUAL=[], TRANS=[];

async function build(){
  const {users,workers} = await loadTeam();
  const docs = needsSync()? await fetchDocs() : loadCache();

  const transfers = refreshTransfers(docs, users, workers);

  QUAL=[];
  TRANS=[];

  let sumQ=0, sumT=0;

  for(const d of docs){
    const user=(d.user||"").trim();
    const wid =(d.workerId||d.id||"").trim();
    if(!users.has(user)&&!workers.has(wid)) continue;

    const cur=Number(d.currentEarnings||0);
    if(cur>=8){
      QUAL.push({user,wid,cur,next:d.nextTransferDate||"-"});
      sumQ+=cur;
    }
  }

  for(const t of transfers){
    TRANS.push(t);
    sumT+=t.amount;
  }

  document.getElementById("sumQ").innerHTML =
    `Qualified (current â‰¥ $8) + Active Transfers: <b>$${(sumQ+sumT).toFixed(2)}</b>`;

  document.getElementById("sumT").innerHTML =
    `Transferred (8thâ€“8th): <b>$${sumT.toFixed(2)}</b>`;

  renderQualified();
  renderTransferred();
}

/* ============================
   RENDER TABLES
============================ */
function renderQualified(){
  const tb=document.getElementById("qbody");
  tb.innerHTML="";
  QUAL.forEach(r=>{
    tb.innerHTML+=`
      <tr>
        <td>${r.user}</td>
        <td>${r.wid}</td>
        <td style="color:green;font-weight:700">${r.cur.toFixed(2)}</td>
        <td>${r.next}</td>
      </tr>`;
  });
}

function renderTransferred(){
  const tb=document.getElementById("tbody");
  tb.innerHTML="";
  TRANS.forEach(r=>{
    tb.innerHTML+=`
      <tr>
        <td>${r.user}</td>
        <td class="${r.mismatch?"mismatch":""}">${r.wid}</td>
        <td style="color:#b91c1c;font-weight:700">${r.amount.toFixed(2)}</td>
        <td>${new Date(r.date).toLocaleDateString()}</td>
      </tr>`;
  });
}

/* ============================
   TABS
============================ */
function tab(t){
  document.getElementById("pq").style.display=t==="q"?"block":"none";
  document.getElementById("pt").style.display=t==="t"?"block":"none";
}

/* ============================
   INIT
============================ */
window.onload=()=>{
  document.getElementById("sync").onclick=()=>{
    localStorage.removeItem(SYNC_KEY);
    build();
  };
  build();
};
</script>

<style>
body{font-family:Segoe UI;background:#f8fafc;padding:20px}
h1{text-align:center;color:#0f62fe}
button{padding:6px 12px;border-radius:6px;border:none;cursor:pointer}
table{width:95%;margin:auto;border-collapse:collapse;background:#fff}
th{background:#0f62fe;color:#fff}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
.mismatch{background:#fff7ed;border-left:4px solid #f97316;font-weight:800}
</style>
</head>

<body>
<h1>ðŸ’° Daily MTurk Earnings Monitor</h1>

<div style="text-align:center;margin-bottom:10px">
  <button id="sync">ðŸ”„ Sync Now</button>
</div>

<div id="sumQ" style="text-align:center;font-size:16px"></div>
<div id="sumT" style="text-align:center;font-size:15px;margin-bottom:10px"></div>

<div style="text-align:center;margin-bottom:10px">
  <button onclick="tab('q')">Qualified</button>
  <button onclick="tab('t')">Transferred</button>
</div>

<div id="pq">
<table>
<thead><tr><th>User</th><th>Worker ID</th><th>Current</th><th>Next</th></tr></thead>
<tbody id="qbody"></tbody>
</table>
</div>

<div id="pt" style="display:none">
<table>
<thead><tr><th>User</th><th>Worker ID</th><th>Transferred</th><th>Date</th></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>

</body>
</html>
