<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ’° MTurk Earnings Monitor (Qualified + Transferred)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { initializeFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================= FIREBASE ================= */
const earningsApp = initializeApp({
  apiKey: "AIzaSyBTFpM3fs7kWBrZL4yOi9tquUTp1HhH7L8",
  authDomain: "mturk-monitordeep.firebaseapp.com",
  projectId: "mturk-monitordeep",
  storageBucket: "mturk-monitordeep.firebasestorage.app",
  messagingSenderId: "505786000194",
  appId: "1:505786000194:web:40b9c9df75d3125f3a99cd"
}, "earningsApp");

const db = initializeFirestore(earningsApp, {
  experimentalForceLongPolling: true,
  useFetchStreams: false
});

/* ================= STORAGE ================= */
const CACHE_KEY = "earnings_cache_data";
const SYNC_KEY  = "earnings_last_sync";
const TRANSFERS_KEY = "earnings_transfers_cache";

/* ================= HELPERS ================= */
const today = () => new Date().toISOString().slice(0,10);
const needsSync = () => localStorage.getItem(SYNC_KEY) !== today();
const markSynced = () => localStorage.setItem(SYNC_KEY, today());

function parseDate(v){
  if(!v) return null;
  const d = new Date(v.includes("/") ? v.replace(/(\d+)\/(\d+)\/(\d+)/,"$3-$1-$2") : v);
  return isNaN(d) ? null : d;
}
function isAfter5th(v){
  const d = parseDate(v); return d && d.getDate() > 5;
}
function activeUntilNext6th(v){
  const d = parseDate(v);
  if(!d) return false;
  const cutoff = new Date(d.getFullYear(), d.getMonth()+1, 6);
  return new Date() < cutoff;
}
const fmt = v => parseDate(v)?.toLocaleDateString() || v || "â€”";

/* ================= TEAM CSV ================= */
async function loadTeam(){
  const res = await fetch("https://docs.google.com/spreadsheets/d/1mf2-AQ59CuboAWz8Fle3qXTFfAI3cnB7mrkqQF1lyCw/export?format=csv&gid=0");
  const rows = (await res.text()).split("\n").slice(1);
  const users=new Set(), workers=new Set();
  rows.forEach(r=>{
    const [u,w]=r.split(",");
    if(u) users.add(u.trim());
    if(w) workers.add(w.trim());
  });
  return {users,workers};
}

/* ================= FIRESTORE ================= */
async function fetchFS(){
  const snap = await getDocs(collection(db,"earnings_logs"));
  const arr=[];
  snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  localStorage.setItem(CACHE_KEY,JSON.stringify(arr));
  markSynced();
  return arr;
}
const loadFS = ()=>JSON.parse(localStorage.getItem(CACHE_KEY)||"[]");

/* ================= TRANSFER CACHE ================= */
const loadTransfers=()=>JSON.parse(localStorage.getItem(TRANSFERS_KEY)||"[]");
const saveTransfers=a=>localStorage.setItem(TRANSFERS_KEY,JSON.stringify(a));

function refreshTransfers(docs,users,workers){
  let cache = loadTransfers().filter(t=>activeUntilNext6th(t.date));

  for(const d of docs){
    const user=(d.user||"").trim();
    const wid=(d.workerId||d.id||"").trim();
    if(!users.has(user)&&!workers.has(wid)) continue;

    const amt=+d.lastTransferAmount||0;
    const dt=d.lastTransferDate;
    if(amt<8||!dt||!isAfter5th(dt)||!activeUntilNext6th(dt)) continue;

    if(!cache.some(x=>x.user===user&&x.workerId===wid&&x.amount===amt&&x.date===dt)){
      cache.push({user,workerId:wid,amount:amt,date:dt});
    }
  }
  saveTransfers(cache);
  return cache;
}

/* ================= BUILD ================= */
async function build(){
  const {users,workers}=await loadTeam();
  const docs = needsSync()?await fetchFS():loadFS();
  const transfers = refreshTransfers(docs,users,workers);

  const Q=[], T=[];
  let qSum=0, tSum=0;

  docs.forEach(d=>{
    const user=(d.user||"").trim();
    const wid=(d.workerId||d.id||"").trim();
    if(!users.has(user)&&!workers.has(wid)) return;
    const cur=+d.currentEarnings||0;
    if(cur>=8){ Q.push({user,wid,cur,next:d.nextTransferDate||"â€”"}); qSum+=cur; }
  });

  transfers.forEach(t=>{ T.push(t); tSum+=t.amount; });

  document.getElementById("totalQualified").innerHTML =
    `Qualified (current â‰¥ $8) + Active Transfers: <b>$${(qSum+tSum).toFixed(2)}</b> (${Q.length} users)`;

  document.getElementById("totalTransferred").innerHTML =
    `Transferred (after 5th, till next 6th): <b>$${tSum.toFixed(2)}</b> (${T.length} transfers)`;

  const qb=document.getElementById("qualified-body"); qb.innerHTML="";
  Q.sort((a,b)=>b.cur-a.cur).forEach(r=>{
    qb.innerHTML+=`<tr><td>${r.user}</td><td>${r.wid}</td><td><b>${r.cur.toFixed(2)}</b></td><td>${r.next}</td></tr>`;
  });

  const tb=document.getElementById("transferred-body"); tb.innerHTML="";
  T.sort((a,b)=>b.amount-a.amount).forEach(r=>{
    tb.innerHTML+=`<tr><td>${r.user}</td><td>${r.workerId}</td><td><b>${r.amount.toFixed(2)}</b></td><td>${fmt(r.date)}</td></tr>`;
  });
}

/* ================= TABS ================= */
const tab=q=>{
  document.getElementById("panel-qualified").style.display=q?"block":"none";
  document.getElementById("panel-transferred").style.display=q?"none":"block";
};

window.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("tab-qualified").onclick=()=>tab(true);
  document.getElementById("tab-transferred").onclick=()=>tab(false);
  document.getElementById("syncNow").onclick=()=>{localStorage.clear();location.reload();};
  tab(true);
  build();
});
</script>

<style>
body{font-family:Segoe UI;background:#f8fafc;padding:20px}
h1{text-align:center;color:#0f62fe}
.tabs{text-align:center;margin:12px}
.tab-btn{padding:8px 16px;border-radius:20px;border:1px solid #ccc;margin:4px;cursor:pointer}
table{width:95%;margin:auto;background:#fff;border-collapse:collapse;box-shadow:0 2px 6px #0002}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#0f62fe;color:#fff}
</style>
</head>

<body>
<h1>ðŸ’° Daily MTurk Earnings Monitor</h1>

<div style="text-align:center;margin-bottom:10px">
  <button id="syncNow">ðŸ”„ Force Sync</button>
</div>

<div id="totalQualified" style="text-align:center;font-weight:bold"></div>
<div id="totalTransferred" style="text-align:center"></div>

<div class="tabs">
  <button id="tab-qualified" class="tab-btn">Qualified</button>
  <button id="tab-transferred" class="tab-btn">Transferred</button>
</div>

<div id="panel-qualified">
<table>
<thead><tr><th>User</th><th>Worker ID</th><th>Current ($)</th><th>Next Transfer</th></tr></thead>
<tbody id="qualified-body"></tbody>
</table>
</div>

<div id="panel-transferred" style="display:none">
<table>
<thead><tr><th>User</th><th>Worker ID</th><th>Transferred ($)</th><th>Date</th></tr></thead>
<tbody id="transferred-body"></tbody>
</table>
</div>

</body>
</html>
