<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>🔥 MTurk Accepted HITs – Live Monitor</title>
<style>
  body { font-family: "Segoe UI", Roboto, sans-serif; background: #f8fafc; color: #111827; padding: 24px; }
  header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  h1 { color: #0f62fe; margin: 0; }
  #raiseTicketBtn { background: #dc2626; color: #fff; font-weight: bold; border: none; border-radius: 8px; padding: 8px 14px; cursor: pointer; }
  #raiseTicketBtn:hover { background: #b91c1c; }
  #onlineCount { display: block; text-align: center; color: #6b7280; margin-bottom: 12px; font-size: 14px; }
  table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
  th, td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; text-align: left; }
  th { background: #0f62fe; color: white; font-weight: 600; }
  tr:hover { background: #f1f5f9; }
  #ticketModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:9999; }
  .modal-content { background:white; border-radius:10px; padding:20px; width:90%; max-width:420px; }
  input,textarea{width:100%;margin:6px 0;padding:8px;border:1px solid #d1d5db;border-radius:6px;}
  #recordBtn{background:#16a34a;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;width:100%;margin:5px 0;}
  #recordBtn.recording{background:#b91c1c;}
  button.submit{background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;width:100%;}
  button.submit:hover{background:#1e40af;}
</style>
</head>
<body>
<header>
  <h1>🔥 MTurk Accepted HITs (Live)</h1>
  <button id="raiseTicketBtn" onclick="openTicketModal()">🎫 Raise Support Ticket</button>
</header>
<span id="onlineCount">0 online</span>
<table>
  <thead><tr><th>User</th><th>Worker ID</th><th>Requester</th><th>Title</th><th>Reward</th><th>Accepted At</th></tr></thead>
  <tbody id="hits-body"></tbody>
</table>

<!-- Ticket Modal -->
<div id="ticketModal">
  <div class="modal-content">
    <h2>🎫 Raise Support Ticket</h2>
    <input id="ticketUserId" placeholder="User ID" />
    <input id="ticketSubject" placeholder="Issue Title" />
    <textarea id="ticketDesc" rows="3" placeholder="Describe issue..."></textarea>
    <label>Attach Screenshot(s):</label>
    <input type="file" id="ticketFile" multiple accept="image/*">
    <button id="recordBtn">🎙 Start Recording</button>
    <audio id="previewAudio" controls style="display:none;width:100%;margin-top:8px;"></audio>
    <button class="submit" id="submitTicket">Submit Ticket</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
      apiKey: "AIzaSyC57W83XkxdvM2aMQK8GIRYR2SJH1ORdfQ",
      authDomain: "mturk-tasks-72994.firebaseapp.com",
      projectId: "mturk-tasks-72994",
      storageBucket: "mturk-tasks-72994.firebasestorage.app",
      messagingSenderId: "305467873275",
      appId: "1:305467873275:web:7b96048865c5305df1dd5e"
    };

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// HIT live snapshot
const tableBody = document.querySelector("#hits-body");
onSnapshot(collection(db,"hits"),(snap)=>{
  const hits=[];
  snap.forEach(doc=>hits.push(doc.data()));
  tableBody.innerHTML="";
  hits.sort((a,b)=>new Date(b.acceptedAt)-new Date(a.acceptedAt));
  for(const h of hits){
    tableBody.innerHTML+=`<tr><td>${h.user||"-"}</td><td>${h.workerId||"-"}</td><td>${h.requester||"-"}</td><td>${h.title||"-"}</td><td>${h.reward||0}</td><td>${h.acceptedAt?new Date(h.acceptedAt).toLocaleString():"-"}</td></tr>`;
  }
});

// Ticket modal
window.openTicketModal=()=>document.getElementById("ticketModal").style.display="flex";
window.closeTicketModal=()=>document.getElementById("ticketModal").style.display="none";
const recordBtn=document.getElementById("recordBtn");
const previewAudio=document.getElementById("previewAudio");
let mediaRecorder,recordedChunks=[],audioBlob=null;
recordBtn.addEventListener("click",async()=>{
  if(!mediaRecorder||mediaRecorder.state==="inactive"){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      recordedChunks=[];mediaRecorder=new MediaRecorder(stream);
      mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data);};
      mediaRecorder.onstop=()=>{audioBlob=new Blob(recordedChunks,{type:"audio/webm"});previewAudio.src=URL.createObjectURL(audioBlob);previewAudio.style.display="block";};
      mediaRecorder.start();recordBtn.textContent="⏹ Stop Recording";recordBtn.classList.add("recording");
    }catch(e){alert("🎤 Microphone access denied.");}
  }else{mediaRecorder.stop();recordBtn.textContent="🎙 Start Recording";recordBtn.classList.remove("recording");}
});
document.getElementById("submitTicket").addEventListener("click",async()=>{
  const userId=document.getElementById("ticketUserId").value.trim();
  const subject=document.getElementById("ticketSubject").value.trim();
  const desc=document.getElementById("ticketDesc").value.trim();
  if(!userId||!subject)return alert("Please enter User ID and subject");
  const attachments=[];
  for(const f of document.getElementById("ticketFile").files){
    const r=ref(storage,`support_attachments/${Date.now()}_${f.name}`);
    await uploadBytes(r,f);
    attachments.push(await getDownloadURL(r));
  }
  let audioUrl="";
  if(audioBlob){
    const aRef=ref(storage,`support_audio/${Date.now()}_${userId}.webm`);
    await uploadBytes(aRef,audioBlob);
    audioUrl=await getDownloadURL(aRef);
  }
  await addDoc(collection(db,"support_tickets"),{userId,subject,description:desc,attachments,audioUrl,status:"open",createdAt:serverTimestamp()});
  alert("✅ Ticket submitted!");
  closeTicketModal();
});
</script>
</body>
</html>
