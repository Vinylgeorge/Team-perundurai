<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ”¥ MTurk Accepted HITs â€“ Live + Earnings</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot,
      doc, setDoc, deleteDoc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // =========================
    // ðŸ”¹ Firebase Config â€“ HITs
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyC57W83XkxdvM2aMQK8GIRYR2SJH1ORdfQ",
      authDomain: "mturk-tasks-72994.firebaseapp.com",
      projectId: "mturk-tasks-72994",
      storageBucket: "mturk-tasks-72994.firebasestorage.app",
      messagingSenderId: "305467873275",
      appId: "1:305467873275:web:7b96048865c5305df1dd5e"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // =========================
    // ðŸ”¹ Firebase Config â€“ Earnings DB
    // =========================
    import { initializeApp as initEarningsApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    const earningsConfig = {
      apiKey: "AIzaSyBTFpM3fs7kWBrZL4yOi9tquUTp1HhH7L8",
      authDomain: "mturk-monitordeep.firebaseapp.com",
      projectId: "mturk-monitordeep",
      storageBucket: "mturk-monitordeep.firebasestorage.app",
      messagingSenderId: "505786000194",
      appId: "1:505786000194:web:40b9c9df75d3125f3a99cd"
    };
    const earningsApp = initEarningsApp(earningsConfig, "earningsApp");
    const earningsDB  = getFirestore(earningsApp);

    // =========================
    // ðŸŸ¢ Presence
    // =========================
    const ROOM = "index";
    const HEARTBEAT_MS = 60000;
    const STALE_MS     = 90000;

    const onlineEl = document.querySelector("#onlineCount");
    const presenceCol = collection(db, `rooms/${ROOM}/presence`);
    const sid = crypto.randomUUID?.() ?? Math.random().toString(36).slice(2);
    const meRef = doc(presenceCol, sid);

    async function startPresence() {
      setDoc(meRef, { since: serverTimestamp(), lastActive: serverTimestamp() }, { merge: true }).catch(()=>{});
      const hb = setInterval(() => {
        setDoc(meRef, { lastActive: serverTimestamp() }, { merge: true }).catch(()=>{});
      }, HEARTBEAT_MS);

      window.addEventListener("beforeunload", () => {
        clearInterval(hb);
        deleteDoc(meRef).catch(()=>{});
      });

      onSnapshot(presenceCol, (snap) => {
        const now = Date.now();
        let count = 0;
        snap.forEach(d => {
          const t = d.data()?.lastActive;
          const ms = t?.toMillis?.() ?? (t ? Date.parse(t) : 0);
          if (ms && (now - ms) <= STALE_MS) count++;
        });
        onlineEl.textContent = `${count} online`;
      });
    }
    startPresence();

    // =========================
    // ðŸ’° Earnings + Transfer Logic
    // =========================
    const totalEl = document.createElement("div");
    totalEl.id = "earningsTotal";
    totalEl.style.cssText = `
      font-size:16px;
      font-weight:bold;
      text-align:center;
      margin-bottom:10px;
    `;

    const subTable = document.createElement("table");
    subTable.id = "qualTable";
    subTable.style.cssText = `
      width:95%;
      margin:0 auto 16px auto;
      border-collapse:collapse;
      background:white;
      border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      display:none;
    `;
    subTable.innerHTML = `
      <thead>
        <tr>
          <th>User</th>
          <th>Worker ID</th>
          <th>Current Earnings ($)</th>
          <th>Next Transfer Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;

    document.addEventListener("DOMContentLoaded", () => {
      const tb = document.querySelector(".titlebar");
      tb.after(totalEl);
      totalEl.after(subTable);
    });

    function setTotalText(text) {
      totalEl.innerHTML = `<a href="#" id="earningsLink" style="color:#15803d;text-decoration:underline;">${text}</a>`;
      const link = document.querySelector("#earningsLink");
      link.addEventListener("click", e => {
        e.preventDefault();
        subTable.style.display = subTable.style.display === "none" ? "table" : "none";
      });
    }

    async function fetchCSV() {
      const res = await fetch("https://docs.google.com/spreadsheets/d/1mf2-AQ59CuboAWz8Fle3qXTFfAI3cnB7mrkqQF1lyCw/export?format=csv&gid=0");
      const text = await res.text();
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      const header = lines[0].split(",").map(h => h.trim().toLowerCase());
      
      const users = new Set(), workers = new Set();

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",");
        const userIdx = header.findIndex(h => h.includes("user"));
        const workerIdx = header.findIndex(h => h.includes("worker"));
        if (userIdx >= 0 && cols[userIdx]) users.add(cols[userIdx].trim());
        if (workerIdx >= 0 && cols[workerIdx]) workers.add(cols[workerIdx].trim());
      }

      return { users, workers };
    }

    async function calcEarnings() {
      try {
        const { users, workers } = await fetchCSV();
        const snap = await getDocs(collection(earningsDB, "earnings_logs"));

        let total = 0;
        let qualifying = [];

        for (const docSnap of snap.docs) {
          const data = docSnap.data();
          const id = docSnap.id;

          const user = (data.user || "").trim();
          const wid = (data.workerId || "").trim();
          const current = parseFloat(data.currentEarnings) || 0;
          const nextDate = data.nextTransferDate || "â€”";

          // retrieve past values
          const lastKnown = parseFloat(data.lastKnownEarnings) || 0;
          const lastTransferAmount = parseFloat(data.lastTransferAmount) || 0;
          const lastTransferDate = data.lastTransferDate || "â€”";

          let status = "Not Yet";
          let displayAmount = current;
          let displayDate = nextDate;

          // â›³ Transfer detection
          if (current < lastKnown) {
            status = "Transferred";
            displayAmount = lastKnown;
            displayDate = nextDate;

            // update Firestore
            await setDoc(doc(earningsDB, "earnings_logs", id), {
              lastTransferAmount: lastKnown,
              lastTransferDate: nextDate,
              lastKnownEarnings: current,
              transferred: true
            }, { merge: true });
          } else {
            // update lastKnown earnings to current
            await setDoc(doc(earningsDB, "earnings_logs", id), {
              lastKnownEarnings: current
            }, { merge: true });
          }

          if ((users.has(user) || workers.has(wid)) && displayAmount >= 8) {
            total += displayAmount;
            qualifying.push({
              user,
              wid,
              val: displayAmount,
              nextDate: displayDate,
              status
            });
          }
        }

        // sort: transferred first
        qualifying.sort((a, b) => {
          if (a.status === "Transferred" && b.status !== "Transferred") return -1;
          if (b.status === "Transferred" && a.status !== "Transferred") return 1;
          return 0;
        });

        setTotalText(`Total Earnings (â‰¥ $8 Users): $${total.toFixed(2)} (${qualifying.length} qualified)`);

        const tbody = subTable.querySelector("tbody");
        tbody.innerHTML = "";

        qualifying.forEach(q => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${q.user}</td>
            <td>${q.wid}</td>
            <td style="color:#15803d;font-weight:600">${q.val.toFixed(2)}</td>
            <td>${q.nextDate}</td>
            <td style="font-weight:bold;color:${q.status === "Transferred" ? "#b91c1c" : "#065f46"}">${q.status}</td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error("âš ï¸ Earnings fetch error:", err);
        setTotalText("âš ï¸ Earnings data unavailable");
      }
    }

    setTimeout(calcEarnings, 1000);
    setInterval(calcEarnings, 5 * 60 * 1000);

    // =========================
    // ðŸ”” HITs Notification
    // =========================

    const tableBody = document.querySelector("#hits-body");
    const soundUrl  = "https://www.allbyjohn.com/sounds/mturkscanner/lessthan15Short.mp3";
    let knownIds = new Set();

    function playSound() {
      const audio = new Audio(soundUrl);
      audio.volume = 0.7;
      audio.play().catch(()=>{});
    }

    function renderTable(hits) {
      tableBody.innerHTML = "";
      hits.sort((a, b) => new Date(b.acceptedAt) - new Date(a.acceptedAt));

      hits.forEach(h => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${h.user || "-"}</td>
          <td>${h.workerId || "-"}</td>
          <td>${h.requester || "-"}</td>
          <td>${h.title || "-"}</td>
          <td>${h.reward || 0}</td>
          <td>${h.acceptedAt ? new Date(h.acceptedAt).toLocaleString() : "-"}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    const titlebar = document.querySelector(".titlebar");
    const notifBtn = document.createElement("button");
    notifBtn.id = "enableNotif";
    notifBtn.textContent = "Enable notifications";
    Object.assign(notifBtn.style, {
      padding:"6px 10px",
      borderRadius:"999px",
      border:"1px solid #d1d5db",
      background:"white",
      cursor:"pointer",
      fontSize:"12px"
    });
    titlebar.appendChild(notifBtn);

    function updateNotifButtonVisibility() {
      if (!("Notification" in window)) {
        notifBtn.style.display="none";
        return;
      }
      notifBtn.style.display = Notification.permission === "granted" ? "none" : "inline-block";
    }
    updateNotifButtonVisibility();

    notifBtn.addEventListener("click", async()=>{
      try { await Notification.requestPermission(); } catch {}
      updateNotifButtonVisibility();
    });

    const notifiedIds = new Set();

    function notifyNewHit(h) {
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") return;
      if (!h.assignmentId || notifiedIds.has(h.assignmentId)) return;

      const title = `New HIT â€¢ ${h.requester || "Requester"}`;
      const body = `${h.title}\nReward: $${h.reward} â€¢ ${h.user || h.workerId}`;
      const n = new Notification(title, { body, tag:h.assignmentId, silent:true });
      
      n.onclick = () => { window.focus(); try { n.close(); } catch {}; };

      notifiedIds.add(h.assignmentId);
      setTimeout(()=>notifiedIds.delete(h.assignmentId),120000);
      setTimeout(()=>{ try{ n.close(); } catch{}; },8000);
    }

    onSnapshot(collection(db, "hits"), (snapshot) => {
      const hits = [];
      const newIds = new Set();
      const hitsById = new Map();

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        hits.push(data);
        if (data.assignmentId) {
          newIds.add(data.assignmentId);
          hitsById.set(data.assignmentId, data);
        }
      });

      if (knownIds.size > 0) {
        const added = [...newIds].filter(id => !knownIds.has(id));
        if (added.length > 0) {
          playSound();
          added.forEach(id => notifyNewHit(hitsById.get(id)));
        }
      }

      knownIds = newIds;
      renderTable(hits);
    });

  </script>

  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #f8fafc;
      color: #111827;
      padding: 24px;
    }
    .titlebar {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    h1 {
      color:#0f62fe;
      margin:0;
    }
    #onlineCount {
      font-size:14px;
      color:#6b7280;
      background:#eef2ff;
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:4px 10px;
    }
    table.main {
      width:100%;
      border-collapse:collapse;
      background:white;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      border-radius:8px;
      overflow:hidden;
    }
    th, td {
      padding:10px 12px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
    }
    th {
      background:#0f62fe;
      color:white;
      font-weight:600;
    }
    tr:hover {
      background:#f1f5f9;
    }
    #qualTable thead th {
      background:#0f62fe;
      color:white;
      font-weight:600;
      text-align:left;
      padding:6px 8px;
    }
    .footer {
      text-align:center;
      margin-top:12px;
      color:#6b7280;
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="titlebar">
    <h1>ðŸ”¥ MTurk Accepted HITs (Live Monitor)</h1>
    <span id="onlineCount">0 online</span>
  </div>

  <table class="main">
    <thead>
      <tr>
        <th>User</th>
        <th>Worker ID</th>
        <th>Requester</th>
        <th>Title</th>
        <th>Reward ($)</th>
        <th>Accepted At</th>
      </tr>
    </thead>
    <tbody id="hits-body"></tbody>
  </table>

  <div class="footer">
    Real-time updates â€¢ Sound + Desktop notifications for new HITs
  </div>
</body>
</html>
