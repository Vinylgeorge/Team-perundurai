<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MTurk Monitor â€” Firestore</title>
  <style>
    body {
      font-family: Inter, Roboto, Arial, sans-serif;
      background: #f7f8fa;
      padding: 20px;
      color: #111827;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background: #f1f3f5;
      text-align: left;
    }
    tr:hover {
      background: #f9fcff;
    }
  </style>
</head>
<body>
  <h1>MTurk Monitor (Realtime)</h1>
  <div id="tableContainer">Loading...</div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_FH-65A526z8g9iGhSYKulS4yiv5e6Ys",
    authDomain: "mturk-monitor.firebaseapp.com",
    projectId: "mturk-monitor",
    storageBucket: "mturk-monitor.firebasestorage.app",
    messagingSenderId: "285174080989",
    appId: "1:285174080989:web:e1f607e6a5f80463278234"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const hitsRef = collection(db, "hits");
  const tableContainer = document.getElementById("tableContainer");

  function buildTable(hits) {
    if (!hits.length) {
      tableContainer.innerHTML = "<p>No HITs in queue</p>";
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>Requester</th>
            <th>Title</th>
            <th>Reward</th>
            <th>Worker ID</th>
            <th>Accepted At</th>
          </tr>
        </thead>
        <tbody>
    `;

    for (const hit of hits) {
      let formattedReward = "-";
      if (hit.reward) {
        if (typeof hit.reward === "string" && hit.reward.trim().startsWith("$")) {
          formattedReward = hit.reward.trim();
        } else {
          const num = Number(hit.reward);
          formattedReward = isNaN(num) ? "-" : `$${num.toFixed(2)}`;
        }
      }

      html += `
        <tr>
          <td>${hit.requester}</td>
          <td>${hit.title}</td>
          <td>${formattedReward}</td>
          <td>${hit.workerId}</td>
          <td>${new Date(hit.acceptedAt).toLocaleString()}</td>
        </tr>
      `;
    }

    html += "</tbody></table>";
    tableContainer.innerHTML = html;
  }

  // ðŸ”´ Realtime Firestore Subscription
  onSnapshot(hitsRef, (snapshot) => {
    const hits = [];
    snapshot.forEach(doc => hits.push(doc.data()));
    buildTable(hits);
    console.log("ðŸ”„ Firestore update:", hits.length);
  });
</script>
</body>
</html>
