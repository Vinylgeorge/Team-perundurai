<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MTurk HITs History</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      margin: 0;
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .day-block {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
      padding: 20px;
      width: 100%;
      max-width: 1000px;
      margin-bottom: 30px;
    }
    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .day-header h2 {
      margin: 0;
      color: #2c3e50;
      font-size: 1.3rem;
    }
    .total-box {
      font-size: 1rem;
      background: #f0f4ff;
      border-radius: 6px;
      padding: 6px 12px;
      color: #1a237e;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #e0e0e0;
      text-align: center;
    }
    th {
      background: #3f51b5;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background: #fafafa;
    }
    .status-submitted { color: green; font-weight: 600; }
    .status-returned { color: red; font-weight: 600; }
    .status-expired { color: orange; font-weight: 600; }
  </style>
</head>
<body>
  <h1>ðŸ“‹ MTurk HITs History</h1>
  <div id="historyContainer">Loading...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_FH-65A526z8g9iGhSYKulS4yiv5e6Ys",
      authDomain: "mturk-monitor.firebaseapp.com",
      projectId: "mturk-monitor",
      storageBucket: "mturk-monitor.firebasestorage.app",
      messagingSenderId: "285174080989",
      appId: "1:285174080989:web:e1f607e6a5f80463278234"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ðŸ”” Play sound when new HIT arrives
    function playHitSound() {
      const audio = new Audio("https://www.allbyjohn.com/sounds/mturkscanner/lessthan15Short.mp3");
      audio.play().catch(err => console.warn("Sound play blocked:", err));
    }

    let firstLoad = true; // avoid sound spam when loading history initially

    function renderHistory(snapshot) {
      const byDay = {};

      snapshot.forEach(doc => {
        const d = doc.data();
        const date = d.acceptedAt ? d.acceptedAt.slice(0,10) : "Unknown";
        if (!byDay[date]) byDay[date] = { total: 0, rows: [] };

        if (d.reward) byDay[date].total += d.reward;

        byDay[date].rows.push(`
          <tr>
            <td>${d.requester || "-"}</td>
            <td>${d.title || "-"}</td>
            <td>${d.reward?.toFixed(2) || "0.00"}</td>
            <td class="status-${d.status || 'unknown'}">${d.status || "-"}</td>
          </tr>
        `);
      });

      const container = document.getElementById("historyContainer");
      container.innerHTML = "";

      Object.keys(byDay).sort((a,b) => b.localeCompare(a)).forEach(date => {
        const block = document.createElement("div");
        block.className = "day-block";
        block.innerHTML = `
          <div class="day-header">
            <h2>${date}</h2>
            <div class="total-box">Total: $${byDay[date].total.toFixed(2)}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Requester</th>
                <th>Title</th>
                <th>Reward ($)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${byDay[date].rows.join("")}
            </tbody>
          </table>
        `;
        container.appendChild(block);
      });

      if (!Object.keys(byDay).length) {
        container.innerHTML = "<p>No data found</p>";
      }
    }

    // ðŸ”„ Live listener for Firestore
    onSnapshot(collection(db, "history"), (snapshot) => {
      if (!firstLoad) {
        playHitSound(); // ðŸ”” only after initial load
      }
      renderHistory(snapshot);
      firstLoad = false;
    });
  </script>
</body>
</html>
