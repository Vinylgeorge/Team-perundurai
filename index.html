<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MTurk Monitor â€” Firestore</title>
</head>
<body>
  <h1>MTurk Monitor (Realtime)</h1>
  <div id="tableContainer">Loading...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_FH-65A526z8g9iGhSYKulS4yiv5e6Ys",
      authDomain: "mturk-monitor.firebaseapp.com",
      projectId: "mturk-monitor",
      storageBucket: "mturk-monitor.firebasestorage.app",
      messagingSenderId: "285174080989",
      appId: "1:285174080989:web:e1f607e6a5f80463278234"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const hitsRef = collection(db, "hits");
    const tableContainer = document.getElementById("tableContainer");

    function buildTable(hits) {
      if (!hits.length) {
        tableContainer.innerHTML = "<p>No HITs in queue</p>";
        return;
      }

      let html = "<table border=1><tr><th>Requester</th><th>Title</th><th>Reward</th><th>Worker ID</th><th>Accepted At</th></tr>";
      for (const hit of hits) {
        html += `<tr>
          <td>${hit.requester}</td>
          <td>${hit.title}</td>
          <td>$${hit.reward.toFixed(2)}</td>
          <td>${hit.workerId}</td>
          <td>${new Date(hit.acceptedAt).toLocaleString()}</td>
        </tr>`;
      }
      html += "</table>";
      tableContainer.innerHTML = html;
    }

    // ðŸ”´ Realtime subscription
    onSnapshot(hitsRef, (snapshot) => {
      const hits = [];
      snapshot.forEach(doc => hits.push(doc.data()));
      buildTable(hits);
      console.log("ðŸ”„ Firestore update:", hits.length);
    });
  </script>
</body>
</html>
